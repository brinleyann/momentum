<!DOCTYPE html>
<html>
<head>
  <title>Momentum</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: system-ui;
      background: #f8fbff;
      padding: 30px;
      color: #2d3748;
    }

    button {
      background: #7dd3fc;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px;
    }

    input {
      padding: 8px;
      margin: 5px;
      border-radius: 6px;
      border: 1px solid #ddd;
    }

    .board {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 10px;
      cursor: pointer;
    }

    .leader {
      background: white;
      padding: 10px;
      margin: 5px 0;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
    }
  </style>
</head>
<body>

<h1>Momentum</h1>

<div id="auth">
  <input id="email" placeholder="email">
  <input id="password" placeholder="password" type="password">
  <input id="username" placeholder="username">
  <button onclick="signUp()">Sign Up</button>
  <button onclick="signIn()">Sign In</button>
</div>

<div id="app" style="display:none">

  <h2>Boards</h2>

  <input id="boardName" placeholder="New board name">
  <button onclick="createBoard()">Create Board</button>

  <div id="boards"></div>

  <h2 id="boardTitle"></h2>

  <button onclick="checkIn()">I showed up today</button>

  <div id="leaderboard"></div>

</div>

<script>

const SUPABASE_URL = "PASTE_URL_HERE"
const SUPABASE_KEY = "PASTE_ANON_KEY_HERE"

const supabase = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_KEY
)

let user = null
let profile = null
let currentBoard = null

checkSession()

async function signUp() {

  const email = document.getElementById("email").value
  const password = document.getElementById("password").value
  const username = document.getElementById("username").value

  const result = await supabase.auth.signUp({
    email,
    password
  })

  const authUser = result.data.user

  await supabase.from("profiles").insert({
    id: authUser.id,
    username,
    streak: 0
  })

  alert("Account created. Now sign in.")
}

async function signIn() {

  const email = document.getElementById("email").value
  const password = document.getElementById("password").value

  await supabase.auth.signInWithPassword({
    email,
    password
  })

  location.reload()
}

async function checkSession() {

  const result = await supabase.auth.getUser()

  if (result.data.user) {

    user = result.data.user

    const profileResult =
      await supabase
      .from("profiles")
      .select("*")
      .eq("id", user.id)
      .single()

    profile = profileResult.data

    document.getElementById("auth").style.display = "none"
    document.getElementById("app").style.display = "block"

    loadBoards()
  }
}

async function createBoard() {

  const name =
    document.getElementById("boardName").value

  const result =
    await supabase
    .from("boards")
    .insert({
      name,
      creator: profile.id
    })
    .select()
    .single()

  await supabase.from("board_members").insert({
    board_id: result.data.id,
    user_id: profile.id
  })

  await supabase.from("scores").insert({
    board_id: result.data.id,
    user_id: profile.id,
    streak: 0
  })

  loadBoards()
}

async function loadBoards() {

  const result =
    await supabase
    .from("boards")
    .select("*")
    .order("created_at", {ascending:false})

  const container =
    document.getElementById("boards")

  container.innerHTML = ""

  result.data.forEach(board => {

    const div =
      document.createElement("div")

    div.className = "board"

    div.innerText = board.name

    div.onclick =
      () => openBoard(board)

    container.appendChild(div)
  })
}

async function openBoard(board) {

  currentBoard = board

  document.getElementById("boardTitle").innerText =
    board.name

  loadLeaderboard()
}

async function checkIn() {

  if (!currentBoard) {
    alert("Select a board first")
    return
  }

  const result =
    await supabase
    .from("scores")
    .select("*")
    .eq("board_id", currentBoard.id)
    .eq("user_id", profile.id)
    .single()

  let streak = result.data.streak
  let last = result.data.last_check_in

  const today =
    new Date().toISOString().slice(0,10)

  if (last !== today)
    streak++

  await supabase
    .from("scores")
    .update({
      streak,
      last_check_in: today
    })
    .eq("id", result.data.id)

  loadLeaderboard()
}

async function loadLeaderboard() {

  const result =
    await supabase
    .from("scores")
    .select(`
      streak,
      profiles(username)
    `)
    .eq("board_id", currentBoard.id)
    .order("streak",{ascending:false})

  const container =
    document.getElementById("leaderboard")

  container.innerHTML = ""

  result.data.forEach((row,index)=>{

    const div =
      document.createElement("div")

    div.className = "leader"

    let medal = ""

    if(index===0) medal="ðŸ¥‡"
    if(index===1) medal="ðŸ¥ˆ"
    if(index===2) medal="ðŸ¥‰"

    div.innerHTML =
      `${index+1}. ${medal}
       ${row.profiles.username}
       <b>${row.streak}</b>`

    container.appendChild(div)
  })
}

</script>

</body>
</html>

